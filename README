#######################################################
#
#
# Initial version - June  2019 - Alberico Perrella Neto
#######################################################

This is an SSL proxy wrapper to encrypt connections between a VOD-9.3 database server and remote client machines. This script works only if the VOD-9.3 server and client machines have the same RHEL version, also:
server: RHEL6.x <--> RHEL6.x : client
server: RHEL7.x <--> RHEL7.x : client
  
This repository has Three scripts:
1- stunnel_install_pre_requisites.sh -> it installs/upgrades all software required to setup the stunnel wrapper;

2- server/stunnel_server_setup.sh -> it setups the stunnel wrapper on the VOD-9.3 server machine.
You need to have a VOD_9.3 server environment defined on the terminal you call this script.
The name of the wrapper will be partially choosen by the script (you will be required to enter a string set, which will be added to the partial defined name). You will need also to enter a valid port number for the SSL server wrapper and another port number for the client wrapper (this last one will be tested in a single remote client machine).
It will setup and startup the stunnel to run a SSL-server wrapper in daemon mode,  generate a self-signed key and a compressed tar file (this tar file has all configuration necessary to setup a client SSL wrapper and also the self-signed key), which will be saved into the /stc/stunnel directory;

3- client/stunnel_client_setup.sh -> This script should be called in any client machine using as argument the previous compressed tar file generated by the stunnel_server_setup.sh script. In case the SSL wrapper client port is alread in use, then this script will inform you and stop (In this case you need to choose if you are going to remove the service associated with this port on your client machine OR edit the config file into the tar file setting up a different unsed port to this client machine).

The main characteristics of the last 2 scripts are:
1- it needs a single port in the client machine for every databse server host. This port will be used to listen/receive TCP/IP packets send by their clients to databses in a single machine. These packets will be encrypted and wrapped in SSL packets that would be forwarded to the SSL database server machine;

2- It needs a single port in the server machine to listen and receive encrytped SSL packets sent by clients;

OBS: 
I- By default Linux Ephemeral port range lies between [32768 - 61000];
II- The Internet Assigned Numbers Authority (IANA) suggests the range 49152 to 65535 (215+214 to 216−1) for dynamic or private ports (BSD);
III- Try to assign both the server and client ssl wrapper a port number inside the two previous listed ranges.

	==== To be done ====

1- Write a function to save the iptables/p6tables rule (make it persistent) even after is rebooted;

2- Write a function in the client script to enforce the client would ONLY be installed if the RHEL version of client and server machines are the same; 

3- In case we implement the stunnel being started by xinetd (currently not by stunnel),then we need to add entries to the sysconfig to get some log output into the /var/log/messages file;

4- Add a mechanism to rotate the stunnel log file;
 





	==== Additional notes ====

I- In case IPv6 is enabled, the operating system would normally prefer an [IOPv6:_port] socket, instead of an [IPv4:port] socket;

Please, observe the following regarding the use of IPv6:

I.a- Each “iptable REDIRECT” rule should be replaced by an equivalent “ip6table REDIRECT“ rule in RHEL-7 platforms;

I.b- In case IPv6 is enabled and the stunnel-server is installed on a RHEL-6 system, then the default ip6table version installed ( ip6tables v1.4.7 ) does not support the creation of “ip6table REDIRECT” rules. In such a case, the “iptable REDIRECT” rules are the only option. In this situation the “bind = <IPv4>” parameter ( the <IPv4> is the IPv4 address of this stunnel-server machine ) should be added to the osc* (Versant Service Connector) file, which is normally located in the “/etc/xinet.d/“ directory. The xinetd must be restarted to listen to new client connections on the socket configured in the /etc/services file ( osc*	<port>/tcp);

II- The stunnel version delivered by default in RHEL-7 (stunnel 4.29 on x86_64-redhat-linux-gnu with OpenSSL 1.0.1e-fips) has a bug (REDHAT BUGZILLA #1498051 ; https://bugzilla.redhat.com/show_bug.cgi?id=1490851 ).  To circumvent this problem on RHEL-7, add the “tips = no” parameter to the stunnel config file, in order to be able to start it up in daemon mode. The “fips = no” parameter should be inserted before the stunnel-server/client definition in its config file;

III- If you plan to use VOD-9.x instead of VOD-8.0, then each VOD-9.x client machine needs only a single iptable/ip6table rule for each VOD-9.x server machine accessed by this client. In this case, you can ignore the setup of the VERSANT_SERVER_PORTS environment variable and the related iptable/ip6table rules for each of those ports.
 

